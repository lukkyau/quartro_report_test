```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(plotly)
library(scales)
library(here)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Load data
raw <- read_csv(here("data", "data.csv"), show_col_types = FALSE)

# Parse dates
data <- raw |>
  mutate(date = as.Date(date, format = "%d/%m/%Y")) %>%
  filter(
    !is.na(date),
    if (!is.null(params$brand)) brand == params$brand else TRUE,
    if (!is.null(params$product)) product == params$product else TRUE
  )

# Aggregate monthly per brand/product
monthly_data <- data |>
  mutate(month = floor_date(date, "month")) |>
  group_by(brand, product, month) |>
  summarise(index = mean(index, na.rm = TRUE), .groups = "drop")

# Build interactive monthly time series plot
plot_ly(
  monthly_data,
  x = ~month,
  y = ~index,
  type = 'scatter',
  mode = 'lines+markers',
  text = ~paste(
    "Index: ", round(index, 2)
  ),
  hoverinfo = 'text') %>%
  config(displayModeBar = FALSE) 
```